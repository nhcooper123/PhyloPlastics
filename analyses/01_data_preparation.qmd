---
title: "Plastic ingestion meta-analysis: data preparation and checking"
author: Andrew MacDonald
format: html
editor: source
bibliography: references.bib
---

This document performs data cleaning and checking for this study.


### Reading data

The following process is based on `PhyloPlas part 1 run models.R`

```{r}
library(ape)
library(tidyverse)


# Import Data and Tree
tree.complete <- read.tree(here::here("data-raw/ConsensusTree.phy")) # This should always be the published version downloaded in 2018.
tree.seabird <- read.tree(here::here("data-raw/ConsensusTree_seabird_matched_2022-06-25.phy")) # This is the published subset of tree.complete based on seabird species names from data
## using readr::read_csv, which avoids making factors, reads Dates in appropriately, and other useful things
data0.1 <- read_csv(here::here("data-raw/2022-10-02  Data S1. Behavioural and life-history dataset.YesNo.csv"))
data0.2 <- read_csv(here::here("data-raw/2022-08-05 Data S2. Plastic ingestion included records for 50,000 individual birds representing 212 seabird species.csv"))

# ocean basin data
basin <- read_csv(here::here("data-raw/2022-08-05 Data S2. Ocean Basins for UniqueID_Plastic_Study(2).csv"), 
                  col_select = UniqueID_Plastic_study:MarineRegion)

glimpse(data0.1)
glimpse(data0.2)
glimpse(basin)
```

## Data transformations and calculations

We do some data transformations before we get to work:

-   median year of a study is recalculated, to give a decimal number

-   some columns are dropped

-   body size is standardized with TWO standard deviations, as suggested by @gelman2008

-   data0.1 and data0.2 are merged

### Calculate median date

```{r median-calc}
## recalculate median so we have a number or NA
data0.2 <- data0.2 |> 
  rowwise() |> 
  mutate(Date_median = median(c(Date_FirstYR, Date_LastYR))) |> 
  ungroup()

# Reclassify & trim data0.1 & data0.2 so that join doesn't result in too many duplicate variables (e.g., SISRecID_BLVr9.x and .y)   

## Conversion to factors is usually not necessary for cleaning data !
# data0.1$SISRecID_BLVr9<-as.factor(data0.1$SISRecID_BLVr9)
# data0.2$SISRecID_BLVr9<-as.factor(data0.2$SISRecID_BLVr9)
```

### Merge datasets

```{r data-merge}
## Dropping columns which we don't need
data0.2 <- data0.2 %>% 
  select(-SISRecID_BLVr9, 
         -Common.name_HBWBLv6,
         # do we for sure not need this
         -ROTL.tip.label,
         -Order,
         -BLFamilyEnglish,
         -Family.Name_HBWBLv6)

# Join the files - Use left_join because this causes issues where there are multiple records with a giving SISRecID (which is used here as a key despite being discontinued by the HBW BirdLife Vr 6 checklist)


data2_joined <- data0.2 |> 
  left_join(data0.1, by = "TipLabel_HBWBLv6") |> 
  left_join(basin,
            by = c(
              "UniqueID_Plastic.study" = "UniqueID_Plastic_study"
              ))


## rearranges a few columns to left of dataset
data2_joined <- data2_joined %>%
  relocate(SISRecID_BLVr9, TipLabel_HBWBLv6, Common.name_HBWBLv6:Link_species)
```

### Convert factors to binary

making the "Yes/No" variables into 0 or 1 helps to clarify how they work in the model

NOTE there are also some missing values!

```{r binary-factors}
## Factors that are "YES" vs "No" can just be binary.-------------
# Set factors
data2_joined |>
  select(Carrion.NonFishVertebrates, Cephalopods, Crustaceans, Fish,
         Other.Inverts, Diet, Anthropogenic.Subsidy,
         pelagic_specialist_CR, DMS.responsive_Dell.Ariccia,
         AS.Fishery, AS.Refuse, AS.Agriculture) |>
  pivot_longer(everything()) |> 
  count(name, value) |> knitr::kable()

# who is this NA in the first few columns
# data2_joined |> 
#   filter(is.na(Crustaceans)) |> glimpse()

data2_binary <- data2_joined |> 
  mutate(across(c(Carrion.NonFishVertebrates, Cephalopods, Crustaceans, Fish,
                  Other.Inverts, Anthropogenic.Subsidy,
                  pelagic_specialist_CR,DMS.responsive_Dell.Ariccia,
                  AS.Fishery, AS.Refuse, AS.Agriculture),
                ~ if_else(.x == "Yes", true = 1, false = 0)))
         

data2_binary |>
  select(c(Carrion.NonFishVertebrates, Cephalopods, Crustaceans, Fish,
                  Other.Inverts, Anthropogenic.Subsidy,
                  pelagic_specialist_CR,DMS.responsive_Dell.Ariccia,
                  AS.Fishery, AS.Refuse, AS.Agriculture)) |> 
  pivot_longer(everything()) |>
  count(name, value) |> 
  knitr::kable()
```

## QAQC of the whole dataset

```{r}

# Are there any new species, which having had trait data added yet? 
traitless <- data2_binary %>% 
  filter(is.na(Diet_description)) %>% 
  droplevels()

if (length(unique(traitless$TipLabel_HBWBLv6)) != 0) stop("something is missing traits") # None? Good.
rm(traitless)

## SELECTING COLUMNS for MODEL --------------
# n  = sample size
# F0 = frequency of occurance
data2 <- data2_binary |> 
  select(
    TipLabel_HBWBLv6,
    ROTL.tip.label,
    Order,
    # main response variable and sample size
    n, FO,
    ## species level stuff
    Body.Mass.g,
    # diet as a factor
    Diet, 
    ## diet breakdown
    Carrion.NonFishVertebrates, Cephalopods, Crustaceans, Fish,
    Other.Inverts, Anthropogenic.Subsidy,
    pelagic_specialist_CR,
    AS.Fishery, AS.Refuse, AS.Agriculture,
    # olfactory trap
    DMS.responsive_Dell.Ariccia,
    ## Study-level predictors
    Source,
    Date_median,
    Feeding.Method.Simple,
    MarineRegion,
    # Site,
    Age.Class,UniqueID_Plastic.study
    ) |>
  # presence of plastic in a species
  mutate(plastic = as.numeric(FO > 0),
         body_mass_2sd = (
           Body.Mass.g - mean(Body.Mass.g, na.rm = TRUE)) / (2 * sd(Body.Mass.g, na.rm = TRUE))
         )

## converting to factors -- handled as binary variables, as in the above
# data2$Carrion.NonFishVertebrates <- as.factor(data2$Carrion.NonFishVertebrates)
# data2$Cephalopods <- as.factor(data2$Cephalopods)
# data2$Crustaceans <- as.factor(data2$Crustaceans)
# data2$Fish <- as.factor(data2$Fish)
# data2$Other.Inverts <- as.factor(data2$Other.Inverts)
# data2$Diet <- as.factor(data2$Diet)
# data2$Anthropogenic.Subsidy <- as.factor(data2$Anthropogenic.Subsidy)
# data2$pelagic_specialist_CR <- as.factor(data2$pelagic_specialist_CR)
# data2$DMS.responsive_Dell.Ariccia <- as.factor(data2$DMS.responsive_Dell.Ariccia)
# data2$AS.Fishery <- as.factor(data2$AS.Fishery)
# data2$AS.Refuse <- as.factor(data2$AS.Refuse)
# data2$AS.Agriculture <- as.factor(data2$AS.Agriculture)

## not necessary -- including sample size as offset
#Counts of ingested and not ingested
# data2$ingested.no <- data2$n - as.integer(data2$n*data2$FO)
# data2$ingested.yes <- as.integer(data2$n*data2$FO)

```

quick check: should also be no NAs in Marine Region

```{r}
data2 |> 
  filter(is.na(MarineRegion))
```

### A few quick checks

```{r}

data2_joined |> 
  select(Date_FirstYR, Date_LastYR, Study.Duration) |> 
  naniar::vis_miss()

# study and bird overlap
data2_joined |> 
  count(Common.name_HBWBLv6) |> 
  arrange(n)

# species richness of a study
data2_joined |> 
  count(Source) |> 
  arrange(desc(n))
  
```

### Freeflying

Rather than recognizing the fine distinctions between different life-history stages, we are aggregating into just two life history stages: free-flying and not (ie nestbound).
this is important because freeflying birds are foraging for themselves, which nestbound birds are consuming food foraged by parents.
However, this is in fact a study-level variable, as studies typically focus on either one the other life history stage.

```{r}

# Relevel factors 
# data2$Diet <- relevel(data2$Diet, ref = "Carrion.NonFishVertebrates")
# unique(data2$Diet)
# data2$Feeding.Method.Simple <- relevel(data2$Feeding.Method.Simple, ref = "Bottom.Feeding")
# unique(data2$Feeding.Method.Simple)
# 
# data2$Age.Class <- relevel(data2$Age.Class, ref = "Nest-bound")
# unique(data2$Age.Class)
# table(data2$Age.Class)

## Free living factor
## mixed is NA Age.Class
# data4$Age.Class |> unique()
# nestbound, subadult more likely
# nestbound vs free flying vs mixed (NA, one or the other)
# free flying == Subadult, Adult, both
# nestbound
# mi


data2_freefly <- data2 |> 
  mutate(is_freeflying = case_when(
    Age.Class == "Nest-bound" ~ 0L,
    Age.Class %in% c("Subadult/Adult", "Adult", "Subadult") ~ 1L,
    Age.Class == "Mixed" ~ NA_integer_
  ))

```

### dropping one bird

We are dropping *Pterodroma macroptera*

```{r}


## dropping this petrel bc of poor fit with the tree
data3 <- data2_freefly %>% 
  filter(TipLabel_HBWBLv6 != c("Pterodroma_macroptera")) %>%
  droplevels()

nrow(data3)
nrow(data2_freefly) - nrow(data3) # removed 9 rows

data2_freefly |> 
  anti_join(data3) |> glimpse()
```

### Editing phylogeny

This code is largely the same as the original document

```{r}


# Make sure nodes in the tree are unique 
# tree.complete$node.label <- as.character(c(1:length(tree.complete$node.label)))
tree.seabird$node.label <- as.character(1:length(tree.seabird$node.label))


## Trimming the species tree
tree <- drop.tip(tree.seabird, 
                 tree.seabird$tip.label[!tree.seabird$tip.label %in% unique(data3$ROTL.tip.label)])

tree <- compute.brlen(tree)

## ARe they any species not in the phylogeny? 
data4 <- data3 |> 
  filter(ROTL.tip.label %in% tree$tip.label)
## nope!

## label NODES sequentially 
tree$node.label <- as.character(1:length(tree$node.label))

# 
# 
# data4$speciesID <- data4$ROTL.tip.label
# data5 <- data4

## EDIT keep full tree also

tree.seabird <- compute.brlen(tree.seabird)


```

## Aggregating within marine basins

Some studies separate birds into small groups (ie specific within-study sampling locations).
However, for the purposes of meta-analyses, we are treating all observations as exchangable (ie as replicates) if they:

-   are collected by the same authors
-   in the same Marine Region
-   in the same year

This aggregates the dataset considerably.

Preliminary step: do many studies occur across different regions:

NOTE here it changes from `data3` to `data5_region_combo` for historical reasons

```{r}
data5_region_combo <- data3 |> 
  mutate(Date_median = round(Date_median)) |> 
  nest_by(TipLabel_HBWBLv6, 
          ROTL.tip.label,
          is_freeflying,
          Source,
          Date_median,
          MarineRegion,
          ) |> 
  mutate(nr = nrow(data)) |> 
  arrange(desc(nr))

## which studies include information from different marine regions??
data5_region_combo |> 
  filter(nr > 1) |> 
  pull(Source) |> 
  unique()
# data5_region_combo$data[[3]] |> View()
```

As a prelude to this aggregation, first calculate the number of birds which ate plastic:s

```{r}
data5_nplas <- data3 |> 
  mutate(n_plastic = round(FO*n))

data5_aggregated <- data5_nplas |> 
  group_by(TipLabel_HBWBLv6, 
           ROTL.tip.label,
           # study level traits
           is_freeflying,
           Source, 
           Date_median, 
           MarineRegion, 
           # species level traits
           body_mass_2sd, 
           Carrion.NonFishVertebrates, 
           Fish,
           Cephalopods,
           Crustaceans,
           Other.Inverts,
           AS.Refuse,
           pelagic_specialist_CR,
           Feeding.Method.Simple#,
           # DMS.responsive_Dell.Ariccia
           ) |> 
  summarize(n_plastic = sum(n_plastic, na.rm = TRUE),
            n_total = sum(n, na.rm = TRUE),
            n_na_plastic = sum(is.na(n_plastic)), .groups = "drop")
```

## Preliminary figures

missing data 

```{r}
naniar::vis_miss(data5_aggregated)
```

```{r}
data5_aggregated |> 
  filter(is.na(Fish)) |> glimpse()
```


```{r}
data5_aggregated |> 
  filter(is.na(Feeding.Method.Simple))
```



```{r}
ggplot(data5_aggregated,aes(x = Date_median, y = n_plastic / n_total, size = n_total)) + geom_point()
```

```{r}
ggplot(data5_aggregated,
       aes(x  = n_plastic / n_total, y = ROTL.tip.label, size = n_total)) + 
  geom_point()
```

```{r}
data5_aggregated |> 
  ggplot(aes(x = Date_median, y = n_plastic/n_total)) + geom_count() + 
  stat_smooth()
```

## Write out data

```{r}
readr::write_csv(data5_aggregated, 
                 file = here::here("data/data5_aggregated.csv"))

readr::write_rds(tree, here::here("data/tree.rds"))

readr::write_rds(tree.seabird,  here::here("data/tree_seabird.rds"))


## also write a version without a small number of annoying NAs which we aren't able to work with:

## remove missing years?
data5_noNAs <- data5_aggregated |> 
  filter(!is.na(Date_median)) |> 
  filter(ROTL.tip.label != "Hydrobates_hornbyi")

## what is lost in this filtering?

data5_aggregated |> 
  anti_join(data5_noNAs, by = join_by(ROTL.tip.label, Source)) |> 
  count(Source)


readr::write_csv(data5_noNAs, file = here::here("data/data_noNA.csv"))

```

We lose a few studies, which include few species each. We also drop one bird species for which very little diet information is available. 

